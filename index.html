<!DOCTYPE html>
<html>
  <head>
    <title>Two Maps</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="https://openlayers.org/en/v4.6.5/css/ol.css" type="text/css">
    <link rel="stylesheet" href="twomaps.css"  type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Fira+Sans|Roboto:400i" rel="stylesheet">
    <!-- The line below is only needed for old environments like Internet Explorer and Android 4.x -->
    <script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=requestAnimationFrame,Element.prototype.classList,URL"></script>
    <script src="https://openlayers.org/en/v4.6.5/build/ol.js"></script>
    <script src="js/elasticsearch.js"> </script>
    <!-- The line below is only needed for old environments like Internet Explorer and Android 4.x -->
    <script src="https://openlayers.org/en/v4.6.5/examples/resources/mapbox-streets-v6-style.js"></script>
    <!-- <script src="js/require.js"> </script> -->
    <script src="js/jQuery.js"> </script>
    <script src="js/flotr2.js"> </script>
  </head>

  <body>

  <header>
    <h2>Comparaison des résultats bruts d'elasticsearch et avec analyse de requête préalable</h2>
  </header>

  <form class="rechercher" action="index.html" method="post">
    <input id="inp" type="text" size="40px" name="Rechercher" value="">
    <button id="rechercher" type="button" name="button" onclick="request()">Rechercher</button>
    <button id="rechercher" type="button" name="button" onclick="refreshLayer()">Actualiser les données</button>
  </form>

  <div id="terme_rech"></div>

    <div class="maps">
      <div class="half">
        <h3>Résultats bruts d'elasticsearch</h3>
        <div id="canvasMap1" class="map"></div>
        <div class="stats">
          <div id="stat1"> Nombre de résultats :</div>
          <div id="tps1">Durée d'exécution :</div>
          <div id="editor-render-0"> </div>

        </div>
      </div>
      <div class="half">
        <h3>Résultats d'elasticsearch avec analyse de requête</h3>
        <div id="canvasMap2" class="map"></div>
        <div class="stats">
          <div id="stat2"> Nombre de résultats :</div>
          <div id="tps2"> Durée d'exécution :</div>
          <div id="editor-render-0"> </div>
        </div>
      </div>
    </div>


    <script>


      var layer = new ol.layer.Tile({
        source: new ol.source.XYZ({
          url: 'https://api.mapbox.com/styles/v1/mapbox/outdoors-v9/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoiYXd3ZXVuYWwiLCJhIjoiMTEzYmJhMWRkNWVkZmUwYjIzMzVjZTVkODlmZjgwNzQifQ.ST5Rw84FYObE52-Be52KAg'
        })
      });
      var view = new ol.View({
        center: [-16720000, -2000000],
        zoom: 7
      });

      // CARTE 1
      var vectorSource1 = new ol.source.Vector({
       url:'res1.geojson',
       format: new ol.format.GeoJSON()
      });
      var vectorLayer1 = new ol.layer.Vector({
       source: vectorSource1
     });
      var map1 = new ol.Map({
        target: 'canvasMap1',
        layers: [layer,vectorLayer1],
        view: view
      });




      // CARTE 2
      var vectorSource2 = new ol.source.Vector({
       url:'res2.geojson',
       format: new ol.format.GeoJSON()
      });
      var vectorLayer2 = new ol.layer.Vector({
        source: vectorSource2
      });
      var map2 = new ol.Map({
        format: new ol.format.GeoJSON(),
        url: 'res2.geojson',
        target: 'canvasMap2',
        layers: [layer,vectorLayer2],
        view: view
      });

      function refreshNbRes(){

        var json = '{"nb1": 50, "nb2": 50, "time1": "0.242014 s", "time2": "0.093005 s"}'
        obj = JSON.parse(json);
        var nbRes1 = obj.nb1;
        var nbRes2 = obj.nb2;
        var t1 = obj.time1;
        var t2 = obj.time2;

        console.log(obj.result);

        document.getElementById('stat1').innerHTML = 'Nombre de résultats : '+nbRes1;
        document.getElementById('stat2').innerHTML = 'Nombre de résultats : '+nbRes2;
        document.getElementById('tps1').innerHTML = 'Durée d\'exécution : '+t1;
        document.getElementById('tps2').innerHTML = 'Durée d\'exécution : '+t2;


      }

      function refreshLayer(){
          refreshNbRes()
          var selectedLayerSource1 = vectorLayer1.getSource();
          var selectedLayerSource2 = vectorLayer2.getSource();

          if(selectedLayerSource1 instanceof ol.source.Vector)
          {
              //do vector reload
              selectedLayerSource1.clear();
              selectedLayerSource2.clear();
              map1.updateSize();
              map2.updateSize();
          }
          else
          {
              //reload the entire page
              window.location.reload();
          }
      }

      function request() {
        var req = document.getElementById("inp").value;
        document.getElementById("terme_rech").innerHTML = 'Requête : '+req;
        var requestURL = 'http://localhost:9200/_search?q='+req;
        var request = new XMLHttpRequest();
        request.open('GET', requestURL);
        request.responseType = 'json';
        console.log(request.response);
        console.log(request.response["hits"]);
        refreshLayer();
      }

      /*
      function UserAction() {
        var req = document.getElementById('inp').value;
        var articlesElt = document.getElementById("articles");
        ajaxGet("http://localhost:9200//_search?q="+req, function (reponse) {
            console.console.log(req);
            // Transforme la réponse en un tableau d'articles
            var articles = JSON.parse(reponse);
            articles.forEach(function (article) {
                // Ajout du titre et du contenu de chaque article
                var titreElt = document.createElement("h2");
                titreElt.textContent = article.titre;
                var contenuElt = document.createElement("p");
                contenuElt.textContent = article.contenu;
                articlesElt.appendChild(titreElt);
                articlesElt.appendChild(contenuElt);
            });
        });
      }

      UserAction()
      */

      /*
      function init(){

      var elasticsearch = require('elasticsearch');
      var client = new elasticsearch.Client({
        host: 'localhost:9200',
        log: 'trace'
      });
      }

      init();
      */
    </script>
  </body>
</html>
